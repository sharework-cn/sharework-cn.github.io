<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>ISTIO Ambient学习</title>
    <link href="/2025/08/17/istio-setup/"/>
    <url>/2025/08/17/istio-setup/</url>
    
    <content type="html"><![CDATA[<h2 id="版本和环境"><a href="#版本和环境" class="headerlink" title="版本和环境"></a>版本和环境</h2><ul><li>istio版本：1.27.0, Ambient</li><li>docker: Docker desktop 28.3.0</li><li>k8s部署方式：minikube in wsl</li><li>k8s版本：v1.32.2</li></ul><p>参考：<a href="https://zhuanlan.zhihu.com/p/1887475409110692661">Istio叫板Spring Cloud：替代之路，道阻且长？</a>。</p><h2 id="镜像准备"><a href="#镜像准备" class="headerlink" title="镜像准备"></a>镜像准备</h2><p>参照<code>https://github.com/togettoyou/hub-mirror</code>提前准备镜像。请注意流水线会将<code>/</code>改为<code>.</code>，因此镜像名<code>quay.io/kiali/kiali:v2.12</code>在流水线完成后，推送到目的仓库会编程<code>quay.io.kiali.kiali:v2.12</code>。</p><p>需准备的镜像包括：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">istio</span>/install-cni:<span class="hljs-number">1</span>.<span class="hljs-number">27</span>.<span class="hljs-number">0</span>-distroless<br><span class="hljs-attribute">istio</span>/proxyv2:<span class="hljs-number">1</span>.<span class="hljs-number">27</span>.<span class="hljs-number">0</span>-distroless<br><span class="hljs-attribute">istio</span>/ztunnel:<span class="hljs-number">1</span>.<span class="hljs-number">27</span>.<span class="hljs-number">0</span>-distroless<br><span class="hljs-attribute">istio</span>/pilot:<span class="hljs-number">1</span>.<span class="hljs-number">27</span>.<span class="hljs-number">0</span>-distroless<br><span class="hljs-attribute">quay</span>.io/kiali/kiali:v2.<span class="hljs-number">12</span><br><span class="hljs-attribute">ghcr</span>.io/prometheus-operator/prometheus-config-reloader:v0.<span class="hljs-number">83</span>.<span class="hljs-number">0</span><br><span class="hljs-attribute">prom</span>/prometheus:v3.<span class="hljs-number">4</span>.<span class="hljs-number">2</span><br><span class="hljs-attribute">grafana</span>/grafana:<span class="hljs-number">12</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h2 id="Kubernetes-Gateway-API"><a href="#Kubernetes-Gateway-API" class="headerlink" title="Kubernetes Gateway API"></a>Kubernetes Gateway API</h2><p>Kubernetes Gateway API 是一个 Kubernetes 的官方项目，用于配置网络流量的标准 API，它提供了一种声明式的方式来配置 Kubernetes 集群中的网络流量路由。</p><p>其提供了一种更强大、更灵活的 API 来替代传统的 Ingress API。它专门设计用于处理集群内外的网络流量路由，支持更复杂的流量管理场景。</p><h3 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h3><h4 id="多层网络抽象"><a href="#多层网络抽象" class="headerlink" title="多层网络抽象"></a><strong>多层网络抽象</strong></h4><ul><li><strong>GatewayClass</strong>: 定义网关的类型和实现</li><li><strong>Gateway</strong>: 定义具体的网关实例</li><li><strong>HTTPRoute&#x2F;TCPRoute&#x2F;UDPRoute</strong>: 定义具体的路由规则</li></ul><h4 id="高级流量管理"><a href="#高级流量管理" class="headerlink" title="高级流量管理"></a><strong>高级流量管理</strong></h4><ul><li>基于路径、头部、查询参数的路由</li><li>流量分割和权重分配</li><li>请求&#x2F;响应修改</li><li>重定向和重写</li><li>超时和重试配置</li></ul><h4 id="多协议支持"><a href="#多协议支持" class="headerlink" title="多协议支持"></a><strong>多协议支持</strong></h4><ul><li>HTTP&#x2F;HTTPS</li><li>TCP</li><li>UDP</li><li>gRPC</li></ul><h4 id="安全特性"><a href="#安全特性" class="headerlink" title="安全特性"></a><strong>安全特性</strong></h4><ul><li>TLS 终止和透传</li><li>证书管理</li><li>访问控制</li></ul><p>详情参见<a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/gateway/">官方文档</a>。</p><p>当前集群的<code>gateway-class</code>:</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">~$ kubectl <span class="hljs-keyword">get</span> gatewayclass<br><span class="hljs-type">NAME</span>             CONTROLLER                    ACCEPTED   AGE<br>istio            istio.io/gateway-controller   <span class="hljs-keyword">True</span>       <span class="hljs-number">26</span>h<br>istio-remote     istio.io/unmanaged-gateway    <span class="hljs-keyword">True</span>       <span class="hljs-number">26</span>h<br>istio-waypoint   istio.io/mesh-controller      <span class="hljs-keyword">True</span>       <span class="hljs-number">26</span>h<br></code></pre></td></tr></table></figure><p>当前集群的<code>gateway</code>:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">~$</span> <span class="hljs-string">kubectl</span> <span class="hljs-string">describe</span> <span class="hljs-string">gateway</span> <span class="hljs-string">bookinfo-gateway</span><br><span class="hljs-attr">Name:</span>         <span class="hljs-string">bookinfo-gateway</span><br><span class="hljs-attr">Namespace:</span>    <span class="hljs-string">istio-lab</span><br><span class="hljs-attr">Labels:</span>       <span class="hljs-string">&lt;none&gt;</span><br><span class="hljs-attr">Annotations:  networking.istio.io/service-type:</span> <span class="hljs-string">ClusterIP</span><br><span class="hljs-attr">API Version:</span>  <span class="hljs-string">gateway.networking.k8s.io/v1</span><br><span class="hljs-attr">Kind:</span>         <span class="hljs-string">Gateway</span><br><span class="hljs-attr">Metadata:</span><br>  <span class="hljs-attr">Creation Timestamp:</span>  <span class="hljs-number">2025-08-16T16:14:08Z</span><br>  <span class="hljs-attr">Generation:</span>          <span class="hljs-number">1</span><br>  <span class="hljs-attr">Resource Version:</span>    <span class="hljs-number">53229</span><br>  <span class="hljs-attr">UID:</span>                 <span class="hljs-string">bb521fdc-e2e7-4da0-acee-7bf70e1b5d5d</span><br><span class="hljs-attr">Spec:</span><br>  <span class="hljs-attr">Gateway Class Name:</span>  <span class="hljs-string">istio</span><br>  <span class="hljs-attr">Listeners:</span><br>    <span class="hljs-attr">Allowed Routes:</span><br>      <span class="hljs-attr">Namespaces:</span><br>        <span class="hljs-attr">From:</span>  <span class="hljs-string">Same</span><br>    <span class="hljs-attr">Name:</span>      <span class="hljs-string">http</span><br>    <span class="hljs-attr">Port:</span>      <span class="hljs-number">80</span><br>    <span class="hljs-attr">Protocol:</span>  <span class="hljs-string">HTTP</span><br><span class="hljs-attr">Status:</span><br>  <span class="hljs-attr">Addresses:</span><br>    <span class="hljs-attr">Type:</span>   <span class="hljs-string">Hostname</span><br>    <span class="hljs-attr">Value:</span>  <span class="hljs-string">bookinfo-gateway-istio.istio-lab.svc.cluster.local</span><br>  <span class="hljs-attr">Conditions:</span><br>    <span class="hljs-attr">Last Transition Time:</span>  <span class="hljs-number">2025-08-16T16:14:08Z</span><br>    <span class="hljs-attr">Message:</span>               <span class="hljs-string">Resource</span> <span class="hljs-string">accepted</span><br>    <span class="hljs-attr">Observed Generation:</span>   <span class="hljs-number">1</span><br>    <span class="hljs-attr">Reason:</span>                <span class="hljs-string">Accepted</span><br>    <span class="hljs-attr">Status:</span>                <span class="hljs-literal">True</span><br>    <span class="hljs-attr">Type:</span>                  <span class="hljs-string">Accepted</span><br>    <span class="hljs-attr">Last Transition Time:</span>  <span class="hljs-number">2025-08-17T02:47:17Z</span><br>    <span class="hljs-attr">Message:</span>               <span class="hljs-string">Resource</span> <span class="hljs-string">programmed,</span> <span class="hljs-string">assigned</span> <span class="hljs-string">to</span> <span class="hljs-string">service(s)</span> <span class="hljs-string">bookinfo-gateway-istio.istio-lab.svc.cl</span><br><span class="hljs-string">uster.local:80</span><br>    <span class="hljs-attr">Observed Generation:</span>   <span class="hljs-number">1</span><br>    <span class="hljs-attr">Reason:</span>                <span class="hljs-string">Programmed</span><br>    <span class="hljs-attr">Status:</span>                <span class="hljs-literal">True</span><br>    <span class="hljs-attr">Type:</span>                  <span class="hljs-string">Programmed</span><br>  <span class="hljs-attr">Listeners:</span><br>    <span class="hljs-attr">Attached Routes:</span>  <span class="hljs-number">1</span><br>    <span class="hljs-attr">Conditions:</span><br>      <span class="hljs-attr">Last Transition Time:</span>  <span class="hljs-number">2025-08-16T16:14:08Z</span><br>      <span class="hljs-attr">Message:</span>               <span class="hljs-literal">No</span> <span class="hljs-string">errors</span> <span class="hljs-string">found</span><br>      <span class="hljs-attr">Observed Generation:</span>   <span class="hljs-number">1</span><br>      <span class="hljs-attr">Reason:</span>                <span class="hljs-string">Accepted</span><br>      <span class="hljs-attr">Status:</span>                <span class="hljs-literal">True</span><br>      <span class="hljs-attr">Type:</span>                  <span class="hljs-string">Accepted</span><br>      <span class="hljs-attr">Last Transition Time:</span>  <span class="hljs-number">2025-08-16T16:14:08Z</span><br>      <span class="hljs-attr">Message:</span>               <span class="hljs-literal">No</span> <span class="hljs-string">errors</span> <span class="hljs-string">found</span><br>      <span class="hljs-attr">Observed Generation:</span>   <span class="hljs-number">1</span><br>      <span class="hljs-attr">Reason:</span>                <span class="hljs-string">NoConflicts</span><br>      <span class="hljs-attr">Status:</span>                <span class="hljs-literal">False</span><br>      <span class="hljs-attr">Type:</span>                  <span class="hljs-string">Conflicted</span><br>      <span class="hljs-attr">Last Transition Time:</span>  <span class="hljs-number">2025-08-16T16:14:08Z</span><br>      <span class="hljs-attr">Message:</span>               <span class="hljs-literal">No</span> <span class="hljs-string">errors</span> <span class="hljs-string">found</span><br>      <span class="hljs-attr">Observed Generation:</span>   <span class="hljs-number">1</span><br>      <span class="hljs-attr">Reason:</span>                <span class="hljs-string">Programmed</span><br>      <span class="hljs-attr">Status:</span>                <span class="hljs-literal">True</span><br>      <span class="hljs-attr">Type:</span>                  <span class="hljs-string">Programmed</span><br>      <span class="hljs-attr">Last Transition Time:</span>  <span class="hljs-number">2025-08-16T16:14:08Z</span><br>      <span class="hljs-attr">Message:</span>               <span class="hljs-literal">No</span> <span class="hljs-string">errors</span> <span class="hljs-string">found</span><br>      <span class="hljs-attr">Observed Generation:</span>   <span class="hljs-number">1</span><br>      <span class="hljs-attr">Reason:</span>                <span class="hljs-string">ResolvedRefs</span><br>      <span class="hljs-attr">Status:</span>                <span class="hljs-literal">True</span><br>      <span class="hljs-attr">Type:</span>                  <span class="hljs-string">ResolvedRefs</span><br>    <span class="hljs-attr">Name:</span>                    <span class="hljs-string">http</span><br>    <span class="hljs-attr">Supported Kinds:</span><br>      <span class="hljs-attr">Group:</span>  <span class="hljs-string">gateway.networking.k8s.io</span><br>      <span class="hljs-attr">Kind:</span>   <span class="hljs-string">HTTPRoute</span><br>      <span class="hljs-attr">Group:</span>  <span class="hljs-string">gateway.networking.k8s.io</span><br>      <span class="hljs-attr">Kind:</span>   <span class="hljs-string">GRPCRoute</span><br><span class="hljs-attr">Events:</span>       <span class="hljs-string">&lt;none&gt;</span><br></code></pre></td></tr></table></figure><p>下列信息表示 Gateway API 资源已经成功配置并分配给了指定的 Kubernetes 服务。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Resource programmed, assigned to <span class="hljs-built_in">service</span>(s) bookinfo-gateway-istio<span class="hljs-selector-class">.istio-lab</span><span class="hljs-selector-class">.svc</span><span class="hljs-selector-class">.cl</span><br>uster<span class="hljs-selector-class">.local</span>:<span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><h2 id="AuthorizationPolicy"><a href="#AuthorizationPolicy" class="headerlink" title="AuthorizationPolicy"></a>AuthorizationPolicy</h2><h3 id="概念与基本配置方法"><a href="#概念与基本配置方法" class="headerlink" title="概念与基本配置方法"></a>概念与基本配置方法</h3><p>AuthorizationPolicy 是 Istio 中用于控制服务间访问权限的重要安全策略，正确配置可以显著提高集群的安全性。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">security.istio.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">AuthorizationPolicy</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">&lt;策略名称&gt;</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">&lt;命名空间&gt;</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">&lt;目标服务标签&gt;</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">source:</span><br>        <span class="hljs-attr">principals:</span> [<span class="hljs-string">&quot;cluster.local/ns/default/sa/default&quot;</span>]<br>    <span class="hljs-attr">to:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">operation:</span><br>        <span class="hljs-attr">methods:</span> [<span class="hljs-string">&quot;GET&quot;</span>]<br>        <span class="hljs-attr">paths:</span> [<span class="hljs-string">&quot;/api/v1/*&quot;</span>]<br>    <span class="hljs-attr">when:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">request.auth.claims[iss]</span><br>      <span class="hljs-attr">values:</span> [<span class="hljs-string">&quot;https://accounts.google.com&quot;</span>]<br></code></pre></td></tr></table></figure><p>在示例教程中的配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f - &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">apiVersion: security.istio.io/v1</span><br><span class="hljs-string">kind: AuthorizationPolicy</span><br><span class="hljs-string">metadata:</span><br><span class="hljs-string">  name: productpage-ztunnel</span><br><span class="hljs-string">  namespace: istio-lab</span><br><span class="hljs-string">spec:</span><br><span class="hljs-string">  selector:</span><br><span class="hljs-string">    matchLabels:</span><br><span class="hljs-string">      app: productpage</span><br><span class="hljs-string">  action: ALLOW</span><br><span class="hljs-string">  rules:</span><br><span class="hljs-string">  - from:</span><br><span class="hljs-string">    - source:</span><br><span class="hljs-string">        principals:</span><br><span class="hljs-string">        - cluster.local/ns/istio-lab/sa/bookinfo-gateway-istio</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure><h3 id="四层和七层授权控制规则"><a href="#四层和七层授权控制规则" class="headerlink" title="四层和七层授权控制规则"></a>四层和七层授权控制规则</h3><p><strong>4层流量控制</strong></p><ul><li>协议级别: TCP、UDP 等传输层协议</li><li>端口级别: 基于端口号进行路由</li><li>无状态: 不解析应用层内容</li><li>性能高: 开销较小，延迟低</li></ul><p><strong>7层流量控制</strong></p><ul><li>协议级别: HTTP&#x2F;HTTPS、gRPC 等应用层协议</li><li>内容感知: 可以解析请求内容</li><li>智能路由: 基于路径、头部、查询参数等</li><li>功能丰富: 支持复杂的流量管理策略</li></ul><h2 id="Waypoint-Proxy"><a href="#Waypoint-Proxy" class="headerlink" title="Waypoint Proxy"></a>Waypoint Proxy</h2><p>为了使用7层授权控制，在对应的命名空间应当添加<code>waypoint proxy</code>。</p>]]></content>
    
    
    
    <tags>
      
      <tag>istio</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2025/08/17/hello-world/"/>
    <url>/2025/08/17/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>测试文章</title>
    <link href="/2021/06/10/test-post/"/>
    <url>/2021/06/10/test-post/</url>
    
    <content type="html"><![CDATA[<p>这是一篇测试文章</p>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>原创</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
